# Bison_Element_Models
R code and Stan code for statistical models of bison element frequencies in Early Holocene archaeological contexts.
This is a work in progress, please feel free to notify me of any errors or to make suggestions. Currently, this project is tailored to
modelling bison element frequencies in Early Holocene archaeological contexts in North America, but, in principle, it could be 
extended to any spatiotemporal context where differential carcass transport decisions are of archaeological interest. Current features
of the code are specific to the bison dataset, but I hope to make this more generalizeable for other contexts in the future.
<br><br>
<b>To fit these models</b>, ensure that your working directory includes the 'Data' and 'Stan models' folders. First, run <i>01_data_preprocessing.R</i>. This script aggregates the information from spreadsheets stored in the 'Data' folder and outputs an RData file (<i>01_Out.RData</i>) that contains a list object to be used as input for either Stan model.<br><br>
Next, decide which Stan model you would like to fit. The first model, <i>m1v2nc.stan</i>, fits a single-predictor model to each dietary utility predictor as well as the bone density predictor, comprising 8 model fits. The second model, <i>m2v2nc.stan</i>, fits a two-predictor model to each dietary utility predictor + the bone density predictor, comprising 7 model fits. For the former set of model fits, run <i>02_fit_Stan_models_01.R</i>, and for the latter set of model fits, run <i>02_fit_Stan_models_02.R</i>. You will need to ensure that <i>01_Out.RData</i> and the 'Stan models' folder, with its Stan files, are both located in the working directory.<br><br>
Both <i>02_fit_Stan_models_0X.R</i> scripts are set up to work across multiple cores. One chain per model is assigned to a core, with four chains per model (2500 sampling and 7500 warmup iterations per chain). As such, for the single-predictor model with 8 fits, the entire set of models can be fit in parallel if 32 (8x4) cores are avilable. For the two-predictor model with 7 fits, the entire set of models can be fitted if 28 (7x4) cores are available.<br><br>
Due to the memory requirements of this script, most personal computers will not be able to run <i>02_fit_Stan_models_01/2.R</i>. I recommend running this script on a cluster node with 512+ GB of RAM. To run it on a personal computer, it will be necessary to modify code in the last portion of the script so that HMC chains are aggregated into model fits sequentially rather than distributing the process across multiple cores. Even in this scenario, a computer will need atleast 9 GB of RAM to complete the process. The other R scripts can be run on a personal computer.<br><br>
The Stan model fitting script will generate an rds file in the 'Stan models' folder after the appropriate Stan model is compiled. I advise against removing this file before the R script has initiated all chains. During model fitting, an 'Out' subdirectory will be created in the 'Stan models' folder. In this subidrectory, the script will continuously output to text files for each Stan model fit. This is the standard Stan model progress output that is displayed when fitting Stan models in R. In this context, since multiple Stan models are being fitted in parallel, you can monitor the progress of each model fit as lines are written to the text file specific to that fit. For the single predictor models, chains generally run for 1.5-2.5 hours, depending on the predictor specific to the model fit (the density data take a bit longer than the dietary utility data). For the two-predictor models, chains generally run for 4-5 hours.<br><br>
The model fitting R scripts will generate several output files upon completion. The first output file is <i>02_mX_out_LOO.RData</i> (where the <i>X</i> is either <i>1</i> or <i>2</i>, depending on which model was used). This data file contains a data frame object with diagnostic summaries for each model fit. Next, a series of <i>02_Out_Models_0X.RData</i> files is generated. These each contain two model fits. The model fits are broken up into multiple files so that they can be loaded into an R session on a personal computer. If they were stored as one RData file, the memory requirements would be too steep for many personal computers.<br><br>
The <i>03_Plot_models_0X.R</i> scripts generate plots of the fitted models. Choose the script with the appropriate numeric suffix, depending on the model that was fitted. This script requires <i>01_Out.RData</i> and all appropriate <i>02_Out_Models_0X.RData</i> files to be in the working directory. These scripts will generate multiple figures in a 'Plots' folder created in the working directory. Within 'Plots', a subfolder for each model fit will be created that contains:
<ol type="1">
 <li>A plot of panels showing known and modelled predictor values, and the modelled distribution of those values for each element. This will be two separate plots for the two-predictor model.</li>
 <li>For the single-predictor model, a series of plots that illustrate the relationship between the predictor variable and element counts within each component (12 component panels per plot). This includes 95% HDPIs for the predictor values, lines marking mean and 95% HPDI relationships, and shaded polygons symbolizing the distribution of posterior predictions around the relationship.</li>
 <li>A plot of panels, one panel for each site type, plotting the mean relationship for each observed component, as well as 500 components simulated from the posterior model fit. For the two-predictor model, each site type has two panels, one for each predictor model.</li>
</ol>
The plots in step 2 take the most time to generate, and, therefore, the single-predictor model fit plots take mroe time to complete than plots for the two-predictor model fits. For the former case, you can expect the plots to finish in 35-45 minutes. For the two-predictor model fits, you can expect the plots to finish in 12-20 minutes. These plots are generate in parallel, but only two cores are used to avoid potential memory limits on personal computers.<br><br>
<b>DATA</b><br><br>
<b>MNE_Data.csv:</b> This sheet contains the archaeological data of interest. Rows are individual site components, containing MNE data and other component specific information, such as site type, element counts, and reference information. Also, note, one row contains information for anatomical frequencies rather than component specific information. There is additional information in this spreadsheet that is not used in the current R or Stan code that I intend to build into other models. Also, note components from later assemblages that are not used in the current models. Currently the R code excludes these components from the models, but in the future, I intend to exand this model beyond Early Holocene contexts.<br><br>
<b>Utility_Data.csv:</b> This sheet contains data from Emerson's (1990) disseration work on the dietary utility of bison carcass portions. There is a column of data for each individual animal that Emerson analyzed. The dietary utility indexes in this sheet include grease utility (GRE), total fat utility (TF_), select fat utility (SF_), skeletal fat utility (SKF), marrow utility (MAR), protein/meat utility (PRO), and total products utility (TP_).<br><br>
<b>Density_Data.csv:</b> This sheet contains data from Kreutzer's (1992) dissertation work on the volume density of scan site locations on bison elements.<br><br>
<b>AdjDensity_Data.csv</b> This sheet contains data from Lam et al.'s (1999) study of CT density values on element scan sites from numerous taxa. Specifically, this sheet contains their data from wildebeest. Their study demonstrated that earlier density measurements used by zooarchaeologists frequently underestimated the density values of elements with voids (e.g., the marrow cavities of long bones). This includes Kreutzer's data. Lam et al. (1999) provide density values for elements both with and without consideration for internal voids. As such, I use these values to provide a rough correction for Kreutzer's bison data, rescaling values for those elements so that their densities are not underestimated. Since Lam et al. (1999) did not measure bison, I used their wildebeest data, as they are likely to be most comparable to the bison data since both animals are bovids (the relative differences between values incorporating voids and those excluding voids are likely to be more similar between bison and wildebeest than they are to be between bison and any other taxon in Lam et al.'s study).
